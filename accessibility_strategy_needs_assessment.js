const pages = [
    {
        "name": "Accessibility Strategy Needs Assessment - Home",
        "type": "home",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024",
        "section-name": "",
        "section-url": ""
    },
    {
        "name": "Home",
        "type": "section",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024",
        "section-name": "Home",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "Executive Summary",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/executive-summary",
        "section-name": "Accessibility Strategy Needs Assessment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "About Accessible Services",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/about-accessible-services",
        "section-name": "Accessibility Strategy Needs Assessment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "Guiding Visions and Values",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/guiding-visions-and-values",
        "section-name": "Accessibility Strategy Needs Assessment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "Who We Serve",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/who-we-serve",
        "section-name": "Accessibility Strategy Needs Assessment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "Glossary",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/glossary",
        "section-name": "Accessibility Strategy Needs Assessment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "1. Streets Capital Projects",
        "type": "section",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-capital-projects",
        "section-name": "Accessibility Strategy Needs Assessment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "1.1 Consistent Accessibility Guidance on Streets Projects",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-capital-projects/11-consistent-accessibility-guidance-on-streets-projects",
        "section-name": "Streets: Capital Projects",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-capital-projects"
    },
    {
        "name": "1.2 Multi-Agency Project Coordination",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-capital-projects/12-multi-agency-project-coordination",
        "section-name": "Streets: Capital Projects",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-capital-projects"
    },
    {
        "name": "1.3 Flexible and Responsive Safety Improvements",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-capital-projects/13-flexible-and-responsive-safety-improvements",
        "section-name": "Streets: Capital Projects",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-capital-projects"
    },
    {
        "name": "1.4 Accessible Pedestrian Signals",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-capital-projects/14-accessible-pedestrian-signals",
        "section-name": "Streets: Capital Projects",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-capital-projects"
    },
    {
        "name": "1.5 Accessible Parking and Loading",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-capital-projects/15-accessible-parking-and-loading",
        "section-name": "Streets: Capital Projects",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-capital-projects"
    },
    {
        "name": "1.6 Parking and Charging of Personal Mobility Devices",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-capital-projects/16-parking-and-charging-of-personal-mobility-devices",
        "section-name": "Streets: Capital Projects",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-capital-projects"
    },
    {
        "name": "2. Streets Policy and Planning",
        "type": "section",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-policy-and-planning",
        "section-name": "Accessibility Strategy Needs Assessment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "2.1 Accessibility-Informed Programs and Planning",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-policy-and-planning/21-accessibility-informed-programs-and-planning",
        "section-name": "Streets: Policy and Planning",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-policy-and-planning"
    },
    {
        "name": "2.2 Accessibility-Informed Data and Evaluations",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-policy-and-planning/22-accessibility-informed-data-and-evaluations",
        "section-name": "Streets: Policy and Planning",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-policy-and-planning"
    },
    {
        "name": "2.3 Accessible Emerging Private Passenger Services",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-policy-and-planning/23-accessible-emerging-private-passenger-services",
        "section-name": "Streets: Policy and Planning",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-policy-and-planning"
    },
    {
        "name": "2.4 Increased Adoption of Adaptive Cycling and Scooter Programs",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-policy-and-planning/24-increased-adoption-of-adaptive-cycling-and-scooter-programs",
        "section-name": "Streets: Policy and Planning",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/streets-policy-and-planning"
    },
    {
        "name": "3. Muni Capital Projects",
        "type": "section",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-capital-projects",
        "section-name": "Accessibility Strategy Needs Assessment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "3.1 Accessible Muni Vehicles",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-capital-projects/31-accessible-muni-vehicles",
        "section-name": "Muni: Capital Projects",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-capital-projects"
    },
    {
        "name": "3.2 Reliable Elevators and Escalators",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-capital-projects/32-reliable-elevators-and-escalators",
        "section-name": "Muni: Capital Projects",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-capital-projects"
    },
    {
        "name": "3.3 Accessible Surface Rail Stops",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-capital-projects/33-accessible-surface-rail-stops",
        "section-name": "Muni: Capital Projects",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-capital-projects"
    },
    {
        "name": "3.4 Accessible Signage and Wayfinding",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-capital-projects/34-accessible-signage-and-wayfinding",
        "section-name": "Muni: Capital Projects",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-capital-projects"
    },
    {
        "name": "3.5 Improved Bus Shelters",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-capital-projects/35-improved-bus-stop-amenities",
        "section-name": "Muni: Capital Projects",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-capital-projects"
    },
    {
        "name": "3.6 Modified Flag Stops",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-capital-projects/36-modified-flag-stops-",
        "section-name": "Muni: Capital Projects",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-capital-projects"
    },
    {
        "name": "4. Muni Service Planning and Policy",
        "type": "section",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-service-planning-and-policy",
        "section-name": "Accessibility Strategy Needs Assessment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "4.1 Service Planning for Accessibility",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-service-planning-and-policy/41-population-specific-travel-patterns-and-concerns-",
        "section-name": "Muni: Service Planning and Policy",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-service-planning-and-policy"
    },
    {
        "name": "4.2 Affordable Muni",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-service-planning-and-policy/42-affordable-muni",
        "section-name": "Muni: Service Planning and Policy",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-service-planning-and-policy"
    },
    {
        "name": "4.3 Operator Training Refreshers Based Upon Customer Feedback",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-service-planning-and-policy/43-operator-training-refreshers-based-upon-customer-feedback",
        "section-name": "Muni: Service Planning and Policy",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-service-planning-and-policy"
    },
    {
        "name": "4.4 Accessible Communication of Service Schedules and Changes",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-service-planning-and-policy/44-accessible-communication-of-service-changes-and-disruptions",
        "section-name": "Muni: Service Planning and Policy",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-service-planning-and-policy"
    },
    {
        "name": "4.5 Continued Community Collaboration",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-service-planning-and-policy/45-continued-community-collaboration",
        "section-name": "Muni: Service Planning and Policy",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/muni-service-planning-and-policy"
    },
    {
        "name": "5. Paratransit Mobility Management",
        "type": "section",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-mobility-management",
        "section-name": "Accessibility Strategy Needs Assessment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "5.1 Effective Travel Training Resources and Materials",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-mobility-management/51-effective-travel-training-resources-and-materials",
        "section-name": "Paratransit: Mobility Management",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-mobility-management"
    },
    {
        "name": "5.2 \"No-Wrong-Door\" Approach",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-mobility-management/52-no-wrong-door-approach",
        "section-name": "Paratransit: Mobility Management",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-mobility-management"
    },
    {
        "name": "5.3 Support Community Health",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-mobility-management/53-support-community-health",
        "section-name": "Paratransit: Mobility Management",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-mobility-management"
    },
    {
        "name": "5.4 Improved Engagement to Non-English Speaking Communities",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-mobility-management/54-improved-engagement-to-non-english-speaking-communities",
        "section-name": "Paratransit: Mobility Management",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-mobility-management"
    },
    {
        "name": "6. Paratransit Capital",
        "type": "section",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-capital",
        "section-name": "Accessibility Strategy Needs Assessment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "6.1 Electric Paratransit Vehicle Procurement",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-capital/61-electric-paratransit-vehicle-procurement",
        "section-name": "Paratransit: Capital",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-capital"
    },
    {
        "name": "6.2 Permanent Paratransit Facility",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-capital/62-permanent-paratransit-facility",
        "section-name": "Paratransit: Capital",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-capital"
    },
    {
        "name": "6.3 Other Physical Technological Investments",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-capital/63-other-physical-technological-investments",
        "section-name": "Paratransit: Capital",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-capital"
    },
    {
        "name": "7. Paratransit Financial",
        "type": "section",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-financial",
        "section-name": "Accessibility Strategy Needs Assessment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "7.1 Cost-Effective Alternatives to Traditional Van Service",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-financial/71-cost-effective-alternatives-to-traditional-van-service",
        "section-name": "Paratransit: Financial",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-financial"
    },
    {
        "name": "7.2 Fare Assistance",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-financial/72-fare-assistance",
        "section-name": "Paratransit: Financial",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-financial"
    },
    {
        "name": "7.3 Clipper Payments for Paratransit Services",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-financial/73-clipper-payments-for-paratransit-services",
        "section-name": "Paratransit: Financial",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-financial"
    },
    {
        "name": "7.4 Fixed Route Fare Policy Impacts on Paratransit",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-financial/74-potential-changes-to-fixed-route-fare-policy",
        "section-name": "Paratransit: Financial",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-financial"
    },
    {
        "name": "8. Paratransit Eligibility and Enrollment",
        "type": "section",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-eligibility-and-enrollment",
        "section-name": "Accessibility Strategy Needs Assessment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "8.1 Regional Eligibility Coordination Efforts",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-eligibility-and-enrollment/81-regional-eligibility-coordination-efforts",
        "section-name": "Paratransit: Eligibility and Enrollment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-eligibility-and-enrollment"
    },
    {
        "name": "8.2 Improved Eligibility and Enrollment Processes",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-eligibility-and-enrollment/82-improved-eligibility-and-enrollment-processes",
        "section-name": "Paratransit: Eligibility and Enrollment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-eligibility-and-enrollment"
    },
    {
        "name": "8.3 Services for Prospective Paratransit Applicants",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-eligibility-and-enrollment/83-services-for-prospective-paratransit-applicants",
        "section-name": "Paratransit: Eligibility and Enrollment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-eligibility-and-enrollment"
    },
    {
        "name": "8.4 Online Scheduling and Payment",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-eligibility-and-enrollment/84-online-scheduling-and-payment",
        "section-name": "Paratransit: Eligibility and Enrollment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-eligibility-and-enrollment"
    },
    {
        "name": "9. Paratransit Service Performance",
        "type": "section",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-service-performance",
        "section-name": "Accessibility Strategy Needs Assessment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "9.1 Same Day Reservations and Chained Trips",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-service-performance/91-partnerships-with-other-agencies-and-providers",
        "section-name": "Paratransit: Service Performance",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-service-performance"
    },
    {
        "name": "9.2 Community Engagement and Partnerships",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-service-performance/92-community-engagement",
        "section-name": "Paratransit: Service Performance",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-service-performance"
    },
    {
        "name": "9.3 Staff and Contractor Recruitment",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-service-performance/93-staff-and-contractor-recruitment",
        "section-name": "Paratransit: Service Performance",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-service-performance"
    },
    {
        "name": "9.4 Regional Paratransit Connections",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-service-performance/94-regional-paratransit-connections",
        "section-name": "Paratransit: Service Performance",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/paratransit-service-performance"
    },
    {
        "name": "10. Taxis",
        "type": "section",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/taxis",
        "section-name": "Accessibility Strategy Needs Assessment",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024"
    },
    {
        "name": "10.1 Accessible Taxi Stands",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/taxis/101-accessible-taxi-stands",
        "section-name": "Taxis",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/taxis"
    },
    {
        "name": "10.2 Ramp Taxi Availability",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/taxis/102-ramp-taxis",
        "section-name": "Taxis",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/taxis"
    },
    {
        "name": "10.3 Accessibility-Informed Taxi Policies",
        "type": "page",
        "url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/taxis/103-accessibility-informed-taxi-policies",
        "section-name": "Taxis",
        "section-url": "https://www.sfmta.com/accessibility-strategy-needs-assessment-2024/taxis"
    }
]

/*
  DEBUG VERSION (no pages array included)

  What this does:
  - If current URL is in the bucket AND there is no <aside>, create:
      <aside class="sidebar section" id="sidebar" role="complementary"></aside>
  - Insert it DIRECTLY AFTER: <main id="main">
  - Adds console logs at each step so you can see what happened
  - Prevents the "asideElement is null" crash in sidebar()
*/

const URL_BUCKET_MATCH = '/accessibility-strategy-needs-assessment-2024';

function logNav(msg, obj) {
  try {
    if (typeof obj !== 'undefined') {
      console.log('[AS-Nav]', msg, obj);
    } else {
      console.log('[AS-Nav]', msg);
    }
  } catch (e) {
    // no-op
  }
}

function isInUrlBucket() {
  const inBucket = window.location.pathname.indexOf(URL_BUCKET_MATCH) !== -1;
  logNav('isInUrlBucket: ' + inBucket + ' | pathname=' + window.location.pathname);
  return inBucket;
}

function ensureAsideExistsAfterMain() {
  if (!isInUrlBucket()) {
    logNav('ensureAsideExistsAfterMain: NOT in bucket, doing nothing');
    return;
  }

  // Prefer the specific aside we create/expect
  let aside = document.querySelector('aside#sidebar');
  if (aside) {
    logNav('ensureAsideExistsAfterMain: aside#sidebar already exists', aside);
    return;
  }

  // If there is some other aside already, log it (but still create sidebar aside if missing)
  const anyAside = document.querySelector('aside');
  if (anyAside) {
    logNav('ensureAsideExistsAfterMain: found an existing <aside> (not #sidebar)', anyAside);
  } else {
    logNav('ensureAsideExistsAfterMain: NO <aside> found on page');
  }

  const mainEl = document.getElementById('main');
  if (!mainEl) {
    logNav('ensureAsideExistsAfterMain: ERROR - <main id="main"> not found. Cannot insert aside in correct location.');
    return;
  }

  // Create the requested aside
  aside = document.createElement('aside');
  aside.classList.add('sidebar', 'section');
  aside.id = 'sidebar';
  aside.setAttribute('role', 'complementary');

  // Insert directly after main#main
  mainEl.insertAdjacentElement('afterend', aside);
  logNav('ensureAsideExistsAfterMain: CREATED and inserted aside directly after main#main', aside);
}

function normalizeUrl(u) {
  return (u || '').replace(/\/$/, '');
}

function main() {
  logNav('main(): start | href=' + window.location.href);

  // Always try to ensure aside exists early (but only acts in bucket)
  ensureAsideExistsAfterMain();

  const currentHref = normalizeUrl(window.location.href);

  const currentPage = pages.find(function (p) { return normalizeUrl(p.url) === currentHref; });
  const currentPageIndex = pages.findIndex(function (p) { return normalizeUrl(p.url) === currentHref; });

  logNav('main(): currentPageIndex=' + currentPageIndex, currentPage);

  if (!currentPage || currentPageIndex < 0) {
    logNav('main(): current page NOT found in pages array. Exiting.');
    return;
  }

  const findPreviousSection = function (pagesList, startIndex) {
    for (let i = startIndex - 1; i >= 0; i--) {
      // FIX: || (not |)
      if (pagesList[i].type === 'section' || pagesList[i].type === 'home') {
        return pagesList[i];
      }
    }
    return null;
  };
  const previousSection = findPreviousSection(pages, currentPageIndex);
  logNav('main(): previousSection', previousSection);

  const findPreviousSectionBeforeParent = function (pagesList, startIndex) {
    let directParentIndex = -1;
    for (let i = startIndex; i >= 0; i--) {
      if (pagesList[i].type === 'section' || pagesList[i].type === 'home') {
        directParentIndex = i;
        break;
      }
    }
    for (let i = directParentIndex - 1; i >= 0; i--) {
      if (pagesList[i].type === 'section' || pagesList[i].type === 'home') {
        return pagesList[i];
      }
    }
    return null;
  };
  const previousSectionBeforeParent = findPreviousSectionBeforeParent(pages, currentPageIndex);
  logNav('main(): previousSectionBeforeParent', previousSectionBeforeParent);

  const findNextSection = function (pagesList, startIndex) {
    for (let i = startIndex + 1; i < pagesList.length; i++) {
      if (pagesList[i].type === 'section') return pagesList[i];
    }
    return null;
  };
  const nextSection = findNextSection(pages, currentPageIndex);
  logNav('main(): nextSection', nextSection);

  const findPreviousPage = function (pagesList, startIndex) {
    for (let i = startIndex - 1; i >= 0; i--) {
      if (pagesList[i].type === 'section') return previousSectionBeforeParent;
      if (pagesList[i].type === 'page') return pagesList[i];
    }
    return null;
  };
  const previousPage = findPreviousPage(pages, currentPageIndex);
  logNav('main(): previousPage', previousPage);

  const findNextPage = function (pagesList, startIndex) {
    for (let i = startIndex + 1; i < pagesList.length; i++) {
      if (pagesList[i].type === 'section') return nextSection;
      if (pagesList[i].type === 'page') return pagesList[i];
    }
    return null;
  };
  const nextPage = findNextPage(pages, currentPageIndex);
  logNav('main(): nextPage', nextPage);

  // Breadcrumbs (guarded)
  const breadcrumbOrderedList = document.querySelector('.breadcrumb nav ol');
  if (!breadcrumbOrderedList) {
    logNav('main(): breadcrumb list not found (.breadcrumb nav ol)');
  } else {
    if (currentPage.type === 'section') {
      const li = document.createElement('li');
      li.classList.add('breadcrumb-item');
      li.innerHTML = '<a href="' + (currentPage['section-url'] || '') + '">' + (currentPage['section-name'] || '') + '</a>';
      if (breadcrumbOrderedList.children && breadcrumbOrderedList.children[1]) {
        breadcrumbOrderedList.insertBefore(li, breadcrumbOrderedList.children[1]);
      } else {
        breadcrumbOrderedList.appendChild(li);
      }
      logNav('main(): breadcrumb inserted for section');
    }

    if (currentPage.type === 'page') {
      const liSection = document.createElement('li');
      liSection.classList.add('breadcrumb-item');
      liSection.innerHTML = '<a href="' + (currentPage['section-url'] || '') + '">' + (currentPage['section-name'] || '') + '</a>';

      if (breadcrumbOrderedList.children && breadcrumbOrderedList.children[1]) {
        breadcrumbOrderedList.insertBefore(liSection, breadcrumbOrderedList.children[1]);
      } else {
        breadcrumbOrderedList.appendChild(liSection);
      }

      if (previousSection && previousSection['section-url'] && previousSection['section-name']) {
        const liHome = document.createElement('li');
        liHome.classList.add('breadcrumb-item');
        liHome.innerHTML = '<a href="' + previousSection['section-url'] + '">' + previousSection['section-name'] + '</a>';
        if (breadcrumbOrderedList.children && breadcrumbOrderedList.children[1]) {
          breadcrumbOrderedList.insertBefore(liHome, breadcrumbOrderedList.children[1]);
        } else {
          breadcrumbOrderedList.appendChild(liHome);
        }
        logNav('main(): breadcrumb inserted for page + home');
      } else {
        logNav('main(): previousSection missing or empty, home breadcrumb not inserted', previousSection);
      }
    }
  }

  // Your navigation sections (kept from original; guarded a bit)
  if (currentPage.type === 'section') {
    const mainContentTag = document.querySelector('#main');
    logNav('main(): section page - mainContentTag', mainContentTag);

    if (mainContentTag) {
      logNav('main(): section nav links will use previousSection and nextSection', { previousSection: previousSection, nextSection: nextSection });

      const newSection = document.createElement('section');
      const prevUrl = previousSection ? previousSection.url : '';
      const prevLabel = previousSection ? (previousSection.type === 'home' ? 'Home' : 'Previous Section') : 'Back';
      const nextHtml = nextSection ? '<a href="' + nextSection.url + '">Next Section</a>' : '';

      newSection.innerHTML =
        '<div style="display:flex;justify-content:space-between;">' +
          '<a href="' + prevUrl + '">' + prevLabel + '</a>' +
          nextHtml +
        '</div>';

      newSection.classList.add('mt-4');
      mainContentTag.appendChild(newSection);
      logNav('main(): section nav appended');
    } else {
      logNav('main(): section page - #main not found, skipping section nav append');
    }
  }

  if (currentPage.type === 'page') {
    const nodeArticle = document.querySelector('.node');
    logNav('main(): page type - .node', nodeArticle);

    if (nodeArticle) {
      const newSection = document.createElement('section');

      const leftHtml = previousPage
        ? '<a href="' + previousPage.url + '">' + (previousPage.type === 'page' ? 'Previous Page' : 'Previous Section') + '</a>'
        : '<a href="https://www.sfmta.com/accessibility-strategy-needs-assessment-2024">Back to Home</a>';

      const rightHtml = nextPage
        ? '<a href="' + nextPage.url + '">' + (nextPage.type === 'page' ? 'Next Page' : 'Next Section') + '</a>'
        : '<a href="https://www.sfmta.com/accessibility-strategy-needs-assessment-2024">Back to Home</a>';

      newSection.innerHTML =
        '<div style="display:flex;justify-content:space-between;">' +
          leftHtml +
          rightHtml +
        '</div>';

      nodeArticle.appendChild(newSection);
      logNav('main(): page nav appended');
    } else {
      logNav('main(): page type - .node not found, skipping page nav append');
    }
  }

  // Sidebar build triggers
  if (currentPage.type === 'page') {
    logNav('main(): calling sidebar() immediately for page type');
    sidebar(currentPageIndex);
  }

  if (currentPage.type === 'section' || currentPage.type === 'home') {
    // Ensure aside is present (insert after main#main if needed) then delay sidebar build slightly
    logNav('main(): section/home - ensuring aside, then delaying sidebar() 25ms');
    ensureAsideExistsAfterMain();
    setTimeout(function () {
      sidebar(currentPageIndex);
    }, 25);
  }

  addSurveyButton();
  logNav('main(): end');
}

function sidebar(currentPageIndex) {
  logNav('sidebar(): start | currentPageIndex=' + currentPageIndex);

  // Make sure aside exists right before we touch it
  ensureAsideExistsAfterMain();

  // Prefer the aside we create
  const asideElement = document.querySelector('aside#sidebar') || document.querySelector('aside[role="complementary"]') || document.querySelector('aside');

  if (!asideElement) {
    logNav('sidebar(): ERROR - asideElement still not found. Aborting sidebar build.');
    return;
  }

  logNav('sidebar(): asideElement found', asideElement);

  // Safe now
  asideElement.classList.add('col-sm-4');

  // Remove existing block-* element if present
  const blockElement = asideElement.querySelector('[id^="block-"]');
  if (blockElement && blockElement.parentNode === asideElement) {
    asideElement.removeChild(blockElement);
    logNav('sidebar(): removed existing block-* element', blockElement);
  } else {
    logNav('sidebar(): no removable block-* element found inside aside');
  }

  let htmlString = '';

  for (let i = 1; i < pages.length; i++) {
    const li = document.createElement('li');
    const a = document.createElement('a');

    li.style.marginTop = '.75rem';
    li.style.marginBottom = '.75rem';

    a.href = pages[i].url;
    a.innerHTML = pages[i].name;

    if (currentPageIndex === i) {
      a.style.textDecoration = 'underline';
    }
    if (pages[i].type === 'page') {
      li.style.marginLeft = '1rem';
    }

    li.innerHTML = a.outerHTML;
    htmlString += li.outerHTML;
  }

  const newSection = document.createElement('section');
  newSection.classList.add('block');
  newSection.style.marginRight = '15px';

  newSection.innerHTML =
    '<h2 class="block-title">' +
      '<span id="heading-id-12iuiu42" style="color:white;font-weight:bold;text-decoration:none;">Accessibility Strategy Needs Assessment</span><br>' +
      '<span style="font-size:16px;font-weight:bold;margin-top:24px;display:block;">Table of Contents</span>' +
    '</h2>' +
    '<div class="view-content">' +
      '<ul style="list-style:none;padding-left:1rem;">' +
        '<li style="margin-top:.75rem;margin-bottom:.75rem;margin-left:0;display:none;">Table of Contents:</li>' +
        htmlString +
      '</ul>' +
    '</div>';

  asideElement.appendChild(newSection);
  logNav('sidebar(): appended newSection to aside');

  const asideParent = asideElement.parentElement;
  if (asideParent) {
    asideParent.id = 'custom-row-id-2376g3279';
    logNav('sidebar(): set aside parent id custom-row-id-2376g3279', asideParent);
  } else {
    logNav('sidebar(): aside parentElement missing, cannot set id');
  }

  // CSS injection (kept from your original, but guarded)
  const style = document.createElement('style');
  style.innerHTML =
    '#heading-id-12iuiu42{color:white;}' +
    '#heading-id-12iuiu42:hover{color:white;text-decoration:none;}' +
    '#custom-row-id-2376g3279 main:first-of-type{position:relative!important;}' +
    '#custom-row-id-2376g3279 aside:first-of-type{position:relative!important;}' +
    '@media (min-width:768px){' +
      '#custom-row-id-2376g3279{display:flex;flex-wrap:wrap;}' +
      '#custom-row-id-2376g3279 > .col-sm-4[role="complementary"]{order:-1;}' +
      '#custom-row-id-2376g3279 > main:first-of-type{width:66.6%!important;}' +
      '#custom-row-id-2376g3279 > aside:first-of-type{width:33.3%!important;}' +
    '}';

  document.head.appendChild(style);
  logNav('sidebar(): injected style tag');

  logNav('sidebar(): end');
}

function addSurveyButton() {
  logNav('addSurveyButton(): start');

  const content = document.getElementById('block-clients-theme-system-main--2');
  if (!content) {
    logNav('addSurveyButton(): content block not found');
    return;
  }

  const article = content.querySelector('article');
  if (!article) {
    logNav('addSurveyButton(): article not found');
    return;
  }

  const fieldShareThis = article.querySelector('.field-share-this');
  if (!fieldShareThis) {
    logNav('addSurveyButton(): .field-share-this not found');
    return;
  }

  const linkedInButton = fieldShareThis.querySelector('.share-linkedIn');
  if (!linkedInButton) {
    logNav('addSurveyButton(): .share-linkedIn not found');
    return;
  }

  const surveyButtonHTML =
    '<br />' +
    '<a target="_blank" class="btn-danger ml-0 mt-3" href="https://survey.alchemer.com/s3/7698449/Accessibility-Strategy-Identified-Needs-Survey-Screen-Reader-Accessible-Version">Take our survey</a>' +
    ' <a style="display:none;" target="_blank" class="btn-danger" href="https://survey.alchemer.com/s3/7698449/Accessibility-Strategy-Identified-Needs-Survey-Screen-Reader-Accessible-Version">Take Our Survey - Screen Reader Friendly Version</a>';

  linkedInButton.insertAdjacentHTML('afterend', surveyButtonHTML);
  logNav('addSurveyButton(): inserted survey button(s)');
}

// Run after DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', main);
} else {
  main();
}
